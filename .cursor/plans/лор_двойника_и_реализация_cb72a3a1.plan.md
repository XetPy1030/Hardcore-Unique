---
name: Лор двойника и реализация
overview: Сформирован атмосферный лор события с «будущим двойником» и зафиксированы ключевые технические решения под Fabric 1.21.x. План ниже переводит идею в конфигурируемую и безопасную для геймплея механику.
todos:
  - id: define-data-model
    content: Определить модель данных события и снапшота игрока (персистентные поля).
    status: completed
  - id: implement-trigger
    content: Сделать триггер события после сна с шансом из конфига.
    status: completed
  - id: implement-double-entity
    content: "Реализовать сущность/контроллер двойника: неподвижность, XP-урон, исчезновение по радиусу."
    status: completed
  - id: config-and-balancing
    content: Добавить конфиг параметров и дефолтные значения баланса.
    status: completed
  - id: persistence-and-edge-cases
    content: "Закрыть персистентность и edge-cases: релог, смерть, выгрузка чанка."
    status: completed
isProject: false
---

# Лор и техплан события «Завтрашний ты»

## Концепт лора

Игроку иногда приходит записка с координатами, написанными его же почерком. Это не квест от мира, а «эхо завтрашнего дня»: место, где он уже был в другой ветке времени.

На точке его ждет неподвижный двойник с тем же скином и «замороженным» инвентарем из момента генерации события. Двойник не бьет по здоровью — он «съедает воспоминания», списывая уровни опыта. Когда игрок подходит слишком близко, двойник рассыпается в частицы и оставляет одну из фраз:

- «Не ходи сюда завтра.»
- «Ты уже был здесь.»

Смысл: это не враг в классическом смысле, а временной паразит, который питается будущими решениями игрока.

## Что уже зафиксировано

- Платформа: Fabric 1.21.x.
- Область действия: событие персонально для каждого игрока.
- Поведение: двойник агрессивен до сближения, при сближении исчезает с запиской.
- Тип урона: списание уровней опыта (flat loss).

## План реализации

1. **Событие-инициатор**
  - На пробуждении/первом тике после сна делать шанс-ролл из конфига.
  - При успехе генерировать персональные координаты и сохранять «активное событие» для игрока.
2. **Снапшот игрока**
  - В момент генерации сохранять: UUID, скин-профиль, копию инвентаря, мир, координаты, timestamp.
  - Эти данные использовать для визуала и логики NPC-двойника.
3. **Спавн и поведение двойника**
  - Спавнить неподвижного NPC/entitу-двойника на целевых координатах.
  - Атаки только по XP-уровням (без урона по HP/броне).
  - При входе игрока в радиус исчезновения: эффект частиц, выдача записки, десpawn.
4. **Лимиты и дебаг-режим**
  - Ввести `maxEncountersPerPlayer` (по умолчанию 1) + возможность увеличивать для дебага.
  - Отдельный флаг `debugForceEvent` для принудительного запуска события.
5. **Конфиг и баланс**
  - Параметры: шанс события, радиус триггера, сила XP-урона, кд между событиями, лимит повторов, набор фраз записки.
  - Значения по умолчанию сделать «редкими, но запоминающимися».
6. **Сохранение состояния**
  - Персистить прогресс игрока (было ли событие, сколько раз сработало, активна ли текущая точка).
  - Корректно обрабатывать перезаход, смерть игрока и выгрузку чанка.

## Критерии готовности

- Игрок получает записку с настраиваемым шансом.
- На точке появляется его двойник с сохраненным видом/инвентарем.
- Двойник наносит только XP-урон.
- При сближении двойник исчезает в частицах и оставляет финальную записку.
- Ограничение «1 раз на игрока» и дебаг-повторы работают через конфиг.

